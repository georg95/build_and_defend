<!doctype html>
<html>
<head>
<meta charset='utf-8'>
<title>mineroids</title>
</head>
<body>
<canvas height='400' width='800' id='game'>Bad browser</canvas>

<script>
    'use strict'
    var context = document.getElementById('game');
    var drawarea = context.getContext('2d');
    var drill = new Image();
    drill.src = "building229.png";
    var turret1 = new Image();
    turret1.src = "turret.png";
    var ship1 = new Image();
    ship1.src = "ship1.png";
    
    var buildmode = "factory";
    var margin = 20;
    var factorycost = 30;
    var turretcost = 50;
    
    var gold = 100;
    var goldprod = 0;
    
    var turretbutton = {};
    turretbutton.x = margin;
    turretbutton.y = margin+40;
    turretbutton.wh_size = 32;
    turretbutton.img = turret1;
    turretbutton.click = function() { buildmode = "turret"; }
    turretbutton.cost = function() { return turretcost; }
    var factorybutton = {};
    factorybutton.x = margin;
    factorybutton.y = turretbutton.y+turretbutton.wh_size+5;
    factorybutton.wh_size = 32;
    factorybutton.img = drill;
    factorybutton.click = function() { buildmode = "factory"; }
    factorybutton.cost = function() { return factorycost; }
    var buttons = [turretbutton, factorybutton];
    

    
    var field = {};
    field.size = 10;
    field.items = [];
    field.getItem = function(x, y) { return this.items[x*this.size+y]; }
    field.setItem = function(x, y, obj) { this.items[x*this.size+y] = obj; }
    field.wh_size = context.height - margin*2;
    field.y_up   = context.height - field.wh_size - margin;
    field.x_left = Math.round(context.width/2 - field.wh_size/2);
    field.step = field.wh_size/field.size;
    
    function getNearBuilding(x,y,radius)
        {
        var near_rad = Infinity;
        var near_obj = undefined;
        for (var px = 0; px < field.size; px++)
        for (var py = 0; py < field.size; py++)
            {
            var currbuild = field.getItem(px,py);
            if (currbuild == undefined) { continue; }
            var bx = currbuild.x;
            var by = currbuild.y;
            var curr_rad = Math.sqrt((bx-x)*(bx-x)+(by-y)*(by-y));
            if (curr_rad < near_rad) { near_rad = curr_rad; near_obj = currbuild; }
            }
        if (near_rad <= radius) { return near_obj; }
        return undefined;
        }
    
    function ship(px, py)
        {
        this.sx = Math.round(field.x_left+field.step*(field.size+px));
        this.sy = Math.round(field.y_up+field.step*py);
        this.x = this.sx;
        this.y = this.sy;
        this.attackTime = 0;
        this.waitTime = 0;
        this.maxhp = 100;
        this.hp = this.maxhp;
        this.act = this.waitattack;
        this.isalive = true;
        this.shootstate = 0;
        }
    ship.prototype.attack = function()
        {
        this.attackTime++;
        
        var build = getNearBuilding(this.x, this.y, 80);
        if (build != undefined)
            {
            if(this.shootstate == 0)
                {
                build.hit(30);
                this.shootstate = 15;
                }
            }
        else { this.x -= 3; }
        if(this.shootstate > 0) { this.shootstate--; }
        if(this.x <= field.x_left)
            {
            this.attackTime = 0;
            this.act = this.goback;
            }
        }
    ship.prototype.goback = function()
        {
        this.sy+=field.step;
        if(this.sy >= field.y_up+field.wh_size) { this.sy = field.y_up; }
        this.x = this.sx;
        this.y = this.sy;
        this.act = this.waitattack;
        this.waitTime = 501;
        }
    ship.prototype.waitattack = function()
        {
        this.waitTime++;
        if(this.waitTime > 500)
            {
            this.waitTime = 0;
            this.act = this.attack;
            }
        }
    ship.prototype.death = function()
        {
        // TODO
        }
    ship.prototype.hit = function(damage)
        {
        this.hp-=damage;
        if (this.hp<=0) { this.hp = 0; this.isalive = false; this.act = this.death; }
        }
    ship.prototype.draw = function(area)
        {
        area.fillStyle = "#0F0";
        area.fillRect(this.x, this.y-4, Math.round(field.step*this.hp/this.maxhp), 4);
        area.drawImage(ship1, this.x, this.y, field.step, field.step);
        }
    var shipt = new ship(2,3);
    function getNearEnemy(x,y,radius)
        {
        if ((x-shipt.x)*(x-shipt.x)+(y-shipt.y)*(y-shipt.y) < radius*radius) { return shipt; }
        return undefined;
        }
    
    function factory(px, py)
        {
        this.x = Math.round(field.x_left+px*field.step);
        this.y = Math.round(field.y_up  +py*field.step);
        this.maxhp = 100;
        this.hp = this.maxhp;
        this.isalive = true;
        factorycost+=5;
        }
    factory.prototype.destroy = function()
        {
        factorycost-=5;
        }
    factory.prototype.draw = function(area)
        {
        area.fillStyle = "#0F0";
        area.fillRect(this.x, this.y-4, Math.round(field.step*this.hp/this.maxhp), 4);
        area.drawImage(drill, this.x, this.y, field.step, field.step);
        }
    factory.prototype.hit = function(damage)
        {
        this.hp-=damage;
        if (this.hp<=0) { this.hp = 0; this.isalive = false; }
        }
    factory.prototype.act = function()
        {
        gold+=0.05;
        }
    function turret(px, py)
        {
        this.x = Math.round(field.x_left+px*field.step);
        this.y = Math.round(field.y_up  +py*field.step);
        this.maxhp = 100;
        this.hp = this.maxhp;
        this.angle = 0;
        this.shootstate = 0;
        this.isalive = true;
        turretcost+=10;
        }
    turret.prototype.destroy = function()
        {
        turretcost-=10;
        }
    turret.prototype.hit = function(damage)
        {
        this.hp-=damage;
        if (this.hp<=0) { this.hp = 0; this.isalive = false; }
        }
    turret.prototype.draw = function(area)
        {
        area.fillStyle = "#0F0";
        area.fillRect(this.x, this.y-4, Math.round(field.step*this.hp/this.maxhp), 4);
        area.translate(Math.round(this.x+field.step/2), Math.round(this.y+field.step/2));
        area.rotate(this.angle);
        area.drawImage(turret1, -Math.round(field.step/2), -Math.round(field.step/2), field.step, field.step);
        area.resetTransform();
        }
    turret.prototype.act = function()
        {
        if(this.angle > Math.PI)  { this.angle-=2*Math.PI; }
        if(this.angle < -Math.PI) { this.angle+=2*Math.PI; }
        var enemy = getNearEnemy(this.x, this.y, 100)
        if(enemy == undefined) { this.angle+=0.1; return; }
        
        var eangle = Math.atan2(enemy.y-this.y, enemy.x-this.x);
        var isscope = true;
        if(eangle - this.angle >  0.3) { this.angle+=0.1; isscope = false; }
        if(eangle - this.angle < -0.3) { this.angle-=0.1; isscope = false; }
        if (this.shootstate == 0) { if(isscope) { enemy.hit(10); this.shootstate=20; } }
        else { if(this.shootstate > 0) { this.shootstate--; } }
        }
    field.click = function(x,y)
        {
        var relx = Math.floor((x-this.x_left)/this.wh_size*this.size);
        var rely = Math.floor((y-this.y_up)/this.wh_size*this.size);
        if (relx >= 0 && rely >= 0 && relx < this.size && rely < this.size)
            {
            if (this.getItem(relx, rely) != undefined) { return; }
            if (buildmode == "factory")
                {
                if (gold < factorycost) { return; }
                gold -= factorycost;
                this.setItem(relx, rely, new factory(relx, rely));
                }
            if (buildmode == "turret")
                {
                if (gold < turretcost) { return; }
                gold -= turretcost;
                this.setItem(relx, rely, new turret(relx, rely));
                }
            }
        }

    console.log(field.items);

    console.log('canvas='+drawarea);
    //field.setItem(3, 7, "factory");



    field.draw = function (drawarea)
        {
        drawarea.strokeStyle="black";

        var step = this.wh_size/this.size;
        drawarea.beginPath();
        for (var i = 1; i < this.size; i++)
            {
            drawarea.moveTo(this.x_left,              this.y_up+i*step);
            drawarea.lineTo(this.x_left+this.wh_size, this.y_up+i*step);
            drawarea.moveTo(this.x_left+i*step, this.y_up);
            drawarea.lineTo(this.x_left+i*step, this.y_up+this.wh_size);
            }
        drawarea.stroke();
        drawarea.strokeRect(this.x_left, this.y_up, this.wh_size, this.wh_size);
        for(var x = 0; x < this.size; x++)
        for(var y = 0; y < this.size; y++)
            {
            if(this.getItem(x,y) === undefined) { continue; }
            this.getItem(x,y).draw(drawarea);
            }
        }


    function ReDraw()
        {
        drawarea.font = "bold 24px courier";
        drawarea.textAlign = "left";
        drawarea.textBaseline = "top";
        drawarea.fillStyle="#334";
        drawarea.fillRect(0,0, context.width, context.height);
        field.draw(drawarea);
        drawarea.fillStyle = "#DD2";
        drawarea.fillText("GOLD: "+Math.floor(gold), margin, margin);
        
        drawarea.font = "bold 10px courier";
        drawarea.textAlign = "right";
        drawarea.textBaseline = "bottom";
        drawarea.fillStyle = "#DD2";    
        for (var i = 0; i < buttons.length; i++)
            {
            drawarea.drawImage(buttons[i].img, buttons[i].x, buttons[i].y,
                               buttons[i].wh_size, buttons[i].wh_size);
            drawarea.fillText("$"+buttons[i].cost(),
                              buttons[i].x+buttons[i].wh_size,
                              buttons[i].y+buttons[i].wh_size);
            }
        var bm = 1;
        if (buildmode == "turret")  { bm = 0; }
        if (buildmode == "factory") { bm = 1; }
        drawarea.strokeStyle="#F00";
        drawarea.strokeRect(buttons[bm].x, buttons[bm].y,
                            buttons[bm].wh_size, buttons[bm].wh_size);

        shipt.draw(drawarea);
        }
    function GameUpdate()
        {
        for(var x = 0; x < field.size; x++)
        for(var y = 0; y < field.size; y++)
            {
            var curritem = field.getItem(x,y);
            if(curritem === undefined) { continue; }
            if(!curritem.isalive) { curritem.destroy(); field.setItem(x,y, undefined); }
            else { curritem.act(); }
            }
        shipt.act();
        if (!shipt.isalive) { shipt = new ship(1+Math.floor(Math.random()*3),Math.floor(Math.random()*field.size)); }
        }
    function GameLoop()
        {
        GameUpdate();
        ReDraw();
        }
    function GameClick(e)
        {
        console.log("Click ("+e.pageX+", "+e.pageY+")");
        var mx = e.pageX-context.offsetLeft;
        var my = e.pageY-context.offsetTop;
        field.click(mx, my);
        for (var i = 0; i < buttons.length; i++)
            {
            if(mx > buttons[i].x && mx < buttons[i].x+buttons[i].wh_size &&
               my > buttons[i].y && my < buttons[i].y+buttons[i].wh_size) { buttons[i].click(); }
            }
        //ReDraw();
        }
    context.onclick=GameClick;
    setInterval(GameLoop, 30);
</script>

</body>
</html>
