<!doctype html>
<html>
<head>
<meta charset='utf-8'>
<title>mineroids</title>
</head>
<body>
<canvas height='400' width='800' id='game'>Bad browser</canvas>

<script>
    'use strict'
    var context = document.getElementById('game');
    var drawarea = context.getContext('2d');
    var drill = new Image();
    drill.src = "building229.png";
    var turret = new Image();
    turret.src = "turret.png";
    var ship1 = new Image();
    ship1.src = "ship1.png";
    
    var buildmode = "factory";
    var margin = 20;
    
    var gold = 100;
    var goldprod = 0;
    
    var turretbutton = {};
    turretbutton.x = margin;
    turretbutton.y = margin+40;
    turretbutton.wh_size = 32;
    turretbutton.img = turret;
    turretbutton.click = function() { buildmode = "turret"; }
    var factorybutton = {};
    factorybutton.x = margin;
    factorybutton.y = turretbutton.y+turretbutton.wh_size+5;
    factorybutton.wh_size = 32;
    factorybutton.img = drill;
    factorybutton.click = function() { buildmode = "factory"; }
    var buttons = [turretbutton, factorybutton];
    
    
    var field = {};
    field.size = 10;
    field.items = [];
    field.getItem = function(x, y) { return this.items[x*this.size+y]; }
    field.setItem = function(x, y, obj) { this.items[x*this.size+y] = obj; }
    field.wh_size = context.height - margin*2;
    field.y_up   = context.height - field.wh_size - margin;
    field.x_left = Math.round(context.width/2 - field.wh_size/2);
    field.step = field.wh_size/field.size;
    field.click = function(x,y)
        {
        var relx = (x-this.x_left)/this.wh_size*this.size;
        var rely = (y-this.y_up)/this.wh_size*this.size;
        if (relx > 0 && rely > 0 && relx < this.size && rely < this.size)
            {
            if (this.getItem(Math.floor(relx), Math.floor(rely)) != undefined) { return; }
            if (buildmode == "factory")
                {
                if (gold < 30) { return; }
                this.setItem(Math.floor(relx), Math.floor(rely), "factory");
                gold -= 30;
                goldprod += 0.05;
                }
            if (buildmode == "turret")
                {
                if (gold < 50) { return; }
                this.setItem(Math.floor(relx), Math.floor(rely), "turret");
                gold -= 50;
                }
            }
        }
    function ship(px, py)
        {
        this.sx = Math.round(field.x_left+field.step*(field.size+px));
        this.sy = Math.round(field.y_up+field.step*py);
        this.x = this.sx;
        this.y = this.sy;
        this.attackTime = 0;
        this.waitTime = 0;
        this.maxhp = 100;
        this.hp = this.maxhp;
        this.act = this.waitattack;
        }
    ship.prototype.attack = function()
        {
        this.attackTime++;
        this.x -= 1;
        if(this.attackTime > 200)
            {
            this.attackTime = 0;
            this.act = this.goback;
            }
        }
    ship.prototype.goback = function()
        {
        this.x = this.sx;
        this.y = this.sy;
        this.act = this.waitattack;
        }
    ship.prototype.waitattack = function()
        {
        this.waitTime++;
        if(this.waitTime > 500)
            {
            this.waitTime = 0;
            this.act = this.attack;
            }
        }
    ship.prototype.draw = function(area)
        {
        area.fillStyle = "#0F0";
        area.fillRect(this.x, this.y-4, Math.round(field.step*this.hp/this.maxhp), 4);
        area.drawImage(ship1, this.x, this.y, field.step, field.step);
        }
    var shipt = new ship(2,3);
    
    console.log(field.items);

    console.log('canvas='+drawarea);
    //field.setItem(3, 7, "factory");



    field.draw = function (drawarea)
        {
        drawarea.strokeStyle="black";

        var step = this.wh_size/this.size;
        drawarea.beginPath();
        for (var i = 1; i < this.size; i++)
            {
            drawarea.moveTo(this.x_left,              this.y_up+i*step);
            drawarea.lineTo(this.x_left+this.wh_size, this.y_up+i*step);
            drawarea.moveTo(this.x_left+i*step, this.y_up);
            drawarea.lineTo(this.x_left+i*step, this.y_up+this.wh_size);
            }
        drawarea.stroke();
        drawarea.strokeRect(this.x_left, this.y_up, this.wh_size, this.wh_size);
        for(var x = 0; x < this.size; x++)
        for(var y = 0; y < this.size; y++)
            {
            if(this.getItem(x,y) === "factory")
                {
                drawarea.drawImage(drill, this.x_left+x*step, this.y_up+y*step, step, step);
                }
            if(this.getItem(x,y) === "turret")
                {
                drawarea.drawImage(turret, this.x_left+x*step, this.y_up+y*step, step, step);
                }
            }
        }

    drawarea.font = "bold 24px courier";
    drawarea.textAlign = "left";
    drawarea.textBaseline = "top";
    function ReDraw()
        {
        drawarea.fillStyle="#334";
        drawarea.fillRect(0,0, context.width, context.height);
        field.draw(drawarea);
        drawarea.fillStyle = "#DD2";
        drawarea.fillText("GOLD: "+Math.floor(gold), margin, margin);
        for (var i = 0; i < buttons.length; i++)
            {
            drawarea.drawImage(buttons[i].img, buttons[i].x, buttons[i].y,
                               buttons[i].wh_size, buttons[i].wh_size);
            }
        var bm = 1;
        if (buildmode == "turret")  { bm = 0; }
        if (buildmode == "factory") { bm = 1; }
        drawarea.strokeStyle="#F00";
        drawarea.strokeRect(buttons[bm].x, buttons[bm].y,
                            buttons[bm].wh_size, buttons[bm].wh_size);
        shipt.draw(drawarea);
        }
    function GameUpdate()
        {
        gold += goldprod;
        shipt.act();
        }
    function GameLoop()
        {
        GameUpdate();
        ReDraw();
        }
    function GameClick(e)
        {
        console.log("Click ("+e.pageX+", "+e.pageY+")");
        var mx = e.pageX-context.offsetLeft;
        var my = e.pageY-context.offsetTop;
        field.click(mx, my);
        for (var i = 0; i < buttons.length; i++)
            {
            if(mx > buttons[i].x && mx < buttons[i].x+buttons[i].wh_size &&
               my > buttons[i].y && my < buttons[i].y+buttons[i].wh_size) { buttons[i].click(); }
            }
        //ReDraw();
        }
    context.onclick=GameClick;
    setInterval(GameLoop, 30);
</script>

</body>
</html>
