<!doctype html>
<html>
<head>
<meta charset='utf-8'>
<title>mineroids</title>
</head>
<body>

<canvas height='400' width='800' id='game'>Bad browser</canvas>

<script>
    'use strict'
    var context = document.getElementById('game');
    var drawarea = context.getContext('2d');
    var boom=[];
    for(var i = 0; i < 9; i++)
        {
        boom[i]=new Image();
        boom[i].src = "boom1/"+(i+1)+".png";
        }
    
    var drill = new Image();
    drill.src = "building229.png";
    var turret1 = new Image();
    turret1.src = "turret.png";
    var ship1 = new Image();
    ship1.src = "ship1.png";
    var scanner1 = new Image();
    scanner1.src = "scanner.png";
    //var laser = new Audio("laser.ogg");
    var mx = 0;
    var my = 0;
    var clicked = false;
    var field = {};
    
    var buildmode = "factory";
    var margin = 20;
    var factorycost = 30;
    var turretcost = 50;
    var scannercost = 200;
    var scannerlvl = 0;
    
    
    var soundeffect =
        {
        lasersounds:[],
        boomsounds:[],
        bulletsouns:[],
        addLaser: function()
            {
            for(var i = 0; i < this.lasersounds.length; i++)
                {
                var cur_snd = this.lasersounds[i];
                if(cur_snd.paused) { cur_snd.play(); break; }
                }
            },
        addBoom: function()
            {
            for(var i = 0; i < this.boomsounds.length; i++)
                {
                var cur_snd = this.boomsounds[i];
                if(cur_snd.paused) { cur_snd.play(); break; }
                }
            },
        addBullet: function()
            {
            for(var i = 0; i < this.bulletsouns.length; i++)
                {
                var cur_snd = this.bulletsouns[i];
                if(cur_snd.paused) { cur_snd.play(); break; }
                }
            }
        };
    for(var i = 0; i < 5; i++)
        {
        soundeffect.lasersounds[i] = new Audio("laser.ogg");
        soundeffect.lasersounds[i].volume = 0.2;
        soundeffect.boomsounds[i] = new Audio("boom.ogg");
        soundeffect.boomsounds[i].volume = 0.2;
        soundeffect.bulletsouns[i] = new Audio("shoot.ogg");
        soundeffect.bulletsouns[i].volume = 0.2;
        }
    var effect =
        {
        alive:true,
        constructor: function(t) { this.time = t; this.alltime=t; return this; },
        act: function() { if(this.time <= 0) { this.alive=false; return; } this.time--; },
        draw: function(area) { ; }
        };
    var effectLaser = Object.create(effect);
    effectLaser.constructor = function(t, sx, sy, fx, fy)
        {
        effect.constructor.apply(this, arguments);
        this.sx = sx;
        this.sy = sy;
        this.fx = fx;
        this.fy = fy;
        soundeffect.addLaser();
        return this;
        };
    effectLaser.draw = function(area)
        {
        area.strokeStyle = "rgba(255,0,0,"+this.time/this.alltime+")";
        area.beginPath();
        area.moveTo(this.sx, this.sy);
        area.lineTo(this.fx, this.fy);
        area.stroke();
        }
    var effectBullet = Object.create(effect);
    effectBullet.constructor = function(t, sx, sy, fx, fy)
        {
        effect.constructor.apply(this, arguments);
        this.sx = sx;
        this.sy = sy;
        this.fx = fx;
        this.fy = fy;
        soundeffect.addBullet();
        return this;
        };
    effectBullet.draw = function(area)
        {
        area.strokeStyle = "#FF0";
        area.beginPath();
        var dx = this.fx-this.sx;
        var dy = this.fy-this.sy;
        var x = this.fx-dx*this.time/this.alltime;
        var y = this.fy-dy*this.time/this.alltime;
        var xx = x+dx/5;
        var yy = y+dy/5;
        if(this.time/this.alltime <= 1/5) { xx=this.fx; yy=this.fy; }
        area.moveTo(x, y);
        area.lineTo(xx, yy);
        area.stroke();
        }
    var effectBoom = Object.create(effect);
    effectBoom.constructor = function(sx, sy)
        {
        effect.constructor.call(this, 8);
        this.sx = sx;
        this.sy = sy;
        soundeffect.addBoom();
        return this;
        }
    effectBoom.draw = function(area)
        {
        area.drawImage(boom[8-this.time],this.sx, this.sy, field.step, field.step);
        }
    var effects = [];
    function updateEffects()
        {
        effects.forEach(function(elem, index, arr)
            { if(elem === undefined) { return; } elem.act(); if(elem.alive === false) { delete arr[index]; } })
        }
    function drawEffects(area)
        {
        //console.log("draw effects");
        effects.forEach(function(elem, index, arr) { if(elem === undefined) { return; } elem.draw(area); } )
        }
    function addEffect(eff)
        {
        //console.log("add effect(" + effects.length+")");
        for(var i = 0; i <= effects.length; i++) // <= is not error, in case if array is full
            {
            if(effects[i] === undefined) { effects[i] = eff; break; }
            }
        }
    
    function winfunction()
        {
        this.state = 0;
        }
    winfunction.prototype.act = function ()
        {
        //console.log("win!");
        this.state += 0.2;
        drawarea.font = "bold 120px sans-serif";
        drawarea.textAlign = "center";
        drawarea.textBaseline = "middle";
        drawarea.fillStyle="#FFF";
        
        drawarea.translate(Math.round(context.width/2), Math.round(context.height/2));
        drawarea.rotate(Math.cos(this.state)/5);
        drawarea.fillText("YOU WIN", 0, 0);
        drawarea.resetTransform();
        }
    var winfunc = new winfunction();
    
    function fieldscan(drawarea)
        {
        if (this.scanenabled === false) { return; }
        drawarea.globalAlpha=0.3;
        for (var x = 0; x < field.size; x++)
        for (var y = 0; y < field.size; y++)
            {
            if (field.getItem(x,y) != undefined) { continue; }
            var valuable = field.getRes(x,y).concentration;
            if(valuable < 7) { drawarea.fillStyle="#F00"; }
            if(valuable >= 7 && valuable < 10) { drawarea.fillStyle="#F80"; }
            if(valuable >= 10 && valuable < 13) { drawarea.fillStyle="#FF0"; }
            if(valuable >= 13) { drawarea.fillStyle="#0F0"; }
            
            drawarea.fillRect(field.x_left+x*field.step+2, field.y_up+y*field.step+2, field.step-4, field.step-4);
            }
        drawarea.globalAlpha=1;
        }
    var fscan = fieldscan.bind({scanenabled:false});
    var gold = 120;
    var winflag = false;
    
    var turretbutton = {};
    turretbutton.x = margin;
    turretbutton.y = margin+40;
    turretbutton.wh_size = 32;
    turretbutton.img = turret1;
    turretbutton.click = function() { buildmode = "turret"; }
    turretbutton.cost = function() { return turretcost; }
    var factorybutton = {};
    factorybutton.x = margin;
    factorybutton.y = turretbutton.y+turretbutton.wh_size+5;
    factorybutton.wh_size = 32;
    factorybutton.img = drill;
    factorybutton.click = function() { buildmode = "factory"; }
    factorybutton.cost = function() { return factorycost; }
    var scannerbutton =
        {
        x: margin,
        y: factorybutton.y+factorybutton.wh_size+5,
        wh_size: 32,
        img: scanner1,
        click: function()
            {
            
            if (gold < scannercost) { return; }
            gold -= scannercost;
            scannercost+=100;
            console.log("scanner");
                fscan = fieldscan.bind({scanenabled: true});
                setTimeout("fscan=fieldscan.bind({scanenabled: false});", 30000);
            scannerlvl++;
            },
        cost: function() { return scannercost; }
        }    
    var buttons = [turretbutton, factorybutton, scannerbutton];
    
    
    field.size = 10;
    field.items = [];
    field.res = [];
    field.getRes = function(x, y)       { return this.res[x*this.size+y]; }
    field.setRes = function(x, y, obj)  { this.res[x*this.size+y] = obj; }
    field.getItem = function(x, y)      { return this.items[x*this.size+y]; }
    field.setItem = function(x, y, obj) { this.items[x*this.size+y] = obj; }
    field.wh_size = context.height - margin*2;
    field.y_up   = context.height - field.wh_size - margin;
    field.x_left = Math.round(context.width/2 - field.wh_size/2);
    field.step = field.wh_size/field.size;
    for(var x = 0; x<field.size; x++)
    for(var y = 0; y<field.size; y++)
        {
        field.setRes(x,y,{res:"gold",concentration:5+Math.floor(Math.random()*10)});
        }
        
    function getNearBuilding(x,y,radius)
        {
        var near_rad = Infinity;
        var near_obj = undefined;
        for (var px = 0; px < field.size; px++)
        for (var py = 0; py < field.size; py++)
            {
            var currbuild = field.getItem(px,py);
            if (currbuild == undefined) { continue; }
            var bx = currbuild.x;
            var by = currbuild.y;
            var curr_rad = Math.sqrt((bx-x)*(bx-x)+(by-y)*(by-y));
            if (curr_rad < near_rad) { near_rad = curr_rad; near_obj = currbuild; }
            }
        if (near_rad <= radius) { return near_obj; }
        return undefined;
        }
    
    function ship(px, py)
        {
        this.sx = Math.round(field.x_left+field.step*(field.size+px));
        this.sy = Math.round(field.y_up+field.step*py);
        this.x = this.sx;
        this.y = this.sy;
        this.attackTime = 0;
        this.waitTime = 0;
        this.maxhp = 100;
        this.hp = this.maxhp;
        this.act = this.waitattack;
        this.isalive = true;
        this.shootstate = 0;
        }
    ship.prototype.attack = function()
        {
        this.attackTime++;
        
        var build = getNearBuilding(this.x, this.y, 80);
        if (build != undefined)
            {
            if(this.shootstate == 0)
                {
                addEffect(Object.create(effectBullet).constructor(
                    10, this.x+field.step/2, this.y+field.step/2, build.x+field.step/2, build.y+field.step/2));
                build.hit(30);
                this.shootstate = 15;
                }
            }
        else { this.x -= 3; }
        if(this.shootstate > 0) { this.shootstate--; }
        if(this.x <= field.x_left)
            {
            this.attackTime = 0;
            this.act = this.goback;
            }
        }
    ship.prototype.goback = function()
        {
        this.sy+=field.step;
        if(this.sy >= field.y_up+field.wh_size) { this.sy = field.y_up; }
        this.x = this.sx;
        this.y = this.sy;
        this.act = this.waitattack;
        this.waitTime = 501;
        }
    ship.prototype.waitattack = function()
        {
        this.waitTime++;
        if(this.waitTime > 500)
            {
            this.waitTime = 0;
            this.act = this.attack;
            }
        }
    ship.prototype.death = function()
        {
        // TODO
        }
    ship.prototype.hit = function(damage)
        {
        if (this.isalive === false) { return; }
        this.hp-=damage;
        if (this.hp<=0)
            {
            this.hp = 0;
            this.isalive = false;
            addEffect(Object.create(effectBoom).constructor(this.x, this.y));
            this.act = this.death;
            }
        }
    ship.prototype.draw = function(area)
        {
        area.fillStyle = "#0F0";
        area.fillRect(this.x, this.y-4, Math.round(field.step*this.hp/this.maxhp), 4);
        area.drawImage(ship1, this.x, this.y, field.step, field.step);
        }
    var shipt = new ship(1,3);
    function getNearEnemy(x,y,radius)
        {
        if (winflag || shipt.act == shipt.waitattack) { return undefined; }
        if ((x-shipt.x)*(x-shipt.x)+(y-shipt.y)*(y-shipt.y) < radius*radius) { return shipt; }
        return undefined;
        }
    
    function factory(px, py)
        {
        this.x = Math.round(field.x_left+px*field.step);
        this.y = Math.round(field.y_up  +py*field.step);
        this.maxhp = 100;
        this.hp = this.maxhp;
        this.isalive = true;
        this.production = field.getRes(px,py).concentration/100;
        factorycost+=5;
        }
    factory.prototype.destroy = function()
        {
        factorycost-=5;
        addEffect(Object.create(effectBoom).constructor(this.x, this.y));
        }
    factory.prototype.draw = function(area)
        {
        area.fillStyle = "#0F0";
        area.fillRect(this.x, this.y-4, Math.round(field.step*this.hp/this.maxhp), 4);
        area.drawImage(drill, this.x, this.y, field.step, field.step);
        }
    factory.prototype.hit = function(damage)
        {
        this.hp-=damage;
        if (this.hp<=0) { this.hp = 0; this.isalive = false; }
        }
    factory.prototype.act = function()
        {
        gold+=this.production;
        }
    function turret(px, py)
        {
        this.x = Math.round(field.x_left+px*field.step);
        this.y = Math.round(field.y_up  +py*field.step);
        this.maxhp = 100;
        this.hp = this.maxhp;
        this.angle = 0;
        this.shootstate = 0;
        this.isalive = true;
        turretcost+=10;
        }
    turret.prototype.destroy = function()
        {
        turretcost-=10;
        addEffect(Object.create(effectBoom).constructor(this.x, this.y));
        }
    turret.prototype.hit = function(damage)
        {
        this.hp-=damage;
        if (this.hp<=0) { this.hp = 0; this.isalive = false; }
        }
    turret.prototype.draw = function(area)
        {
        area.fillStyle = "#0F0";
        area.fillRect(this.x, this.y-4, Math.round(field.step*this.hp/this.maxhp), 4);
        area.translate(Math.round(this.x+field.step/2), Math.round(this.y+field.step/2));
        area.rotate(this.angle);
        area.drawImage(turret1, -Math.round(field.step/2), -Math.round(field.step/2), field.step, field.step);
        area.resetTransform();
        }
    turret.prototype.act = function()
        {
        if(this.angle > Math.PI)  { this.angle-=2*Math.PI; }
        if(this.angle < -Math.PI) { this.angle+=2*Math.PI; }
        var enemy = getNearEnemy(this.x, this.y, 200)
        if(enemy == undefined) { this.angle+=0.1; return; }
        
        var eangle = Math.atan2(enemy.y-this.y, enemy.x-this.x);
        var isscope = true;
        if(eangle - this.angle >  0.12) { this.angle+=0.1; isscope = false; }
        if(eangle - this.angle < -0.12) { this.angle-=0.1; isscope = false; }
        if (this.shootstate == 0)
            {
            if(isscope)
                {
                addEffect(Object.create(effectLaser).constructor(
                    20, this.x+field.step/2, this.y+field.step/2, enemy.x+field.step/2, enemy.y+field.step/2));
                enemy.hit(3);
                this.shootstate=20;
                }
            }
        else { if(this.shootstate > 0) { this.shootstate--; } }
        }
    field.click = function(x,y)
        {
        var relx = Math.floor((x-this.x_left)/this.wh_size*this.size);
        var rely = Math.floor((y-this.y_up)/this.wh_size*this.size);
        if (relx >= 0 && rely >= 0 && relx < this.size && rely < this.size)
            {
            if (this.getItem(relx, rely) != undefined) { return; }
            if (buildmode == "factory")
                {
                if (gold < factorycost) { return; }
                gold -= factorycost;
                this.setItem(relx, rely, new factory(relx, rely));
                }
            if (buildmode == "turret")
                {
                if (gold < turretcost) { return; }
                gold -= turretcost;
                this.setItem(relx, rely, new turret(relx, rely));
                }
            }
        }

    console.log(field.items);

    console.log('canvas='+drawarea);
    //field.setItem(3, 7, "factory");



    field.draw = function (drawarea)
        {
        drawarea.strokeStyle="black";

        var step = this.wh_size/this.size;
        drawarea.beginPath();
        for (var i = 1; i < this.size; i++)
            {
            drawarea.moveTo(this.x_left,              this.y_up+i*step);
            drawarea.lineTo(this.x_left+this.wh_size, this.y_up+i*step);
            drawarea.moveTo(this.x_left+i*step, this.y_up);
            drawarea.lineTo(this.x_left+i*step, this.y_up+this.wh_size);
            }
        drawarea.stroke();
        drawarea.strokeRect(this.x_left, this.y_up, this.wh_size, this.wh_size);
        for(var x = 0; x < this.size; x++)
        for(var y = 0; y < this.size; y++)
            {
            if(this.getItem(x,y) === undefined) { continue; }
            this.getItem(x,y).draw(drawarea);
            }
        }


    function ReDraw()
        {
        drawarea.font = "bold 24px courier";
        drawarea.textAlign = "left";
        drawarea.textBaseline = "top";
        drawarea.fillStyle="#334";
        drawarea.fillRect(0,0, context.width, context.height);
        fscan(drawarea);
        field.draw(drawarea);
        drawarea.fillStyle = "#DD2";
        drawarea.fillText("GOLD: "+Math.floor(gold), margin, margin);
        
        drawarea.font = "bold 10px courier";
        drawarea.textAlign = "right";
        drawarea.textBaseline = "bottom";
        drawarea.fillStyle = "#DD2";    
        for (var i = 0; i < buttons.length; i++)
            {
            drawarea.drawImage(buttons[i].img, buttons[i].x, buttons[i].y,
                               buttons[i].wh_size, buttons[i].wh_size);
            drawarea.fillText("$"+buttons[i].cost(),
                              buttons[i].x+buttons[i].wh_size,
                              buttons[i].y+buttons[i].wh_size);
            }
        var bm = 1;
        if (buildmode == "turret")  { bm = 0; }
        if (buildmode == "factory") { bm = 1; }
        drawarea.strokeStyle="#F00";
        drawarea.strokeRect(buttons[bm].x, buttons[bm].y,
                            buttons[bm].wh_size, buttons[bm].wh_size);

        if(!winflag) { shipt.draw(drawarea); }
        
        drawEffects(drawarea);
        if(winflag)
            {
            winfunc.act(); 
            //return;
            }
        }
    function GameUpdate()
        {
        if (clicked)
            {
            field.click(mx, my);
            for (var i = 0; i < buttons.length; i++)
                {
                if(mx > buttons[i].x && mx < buttons[i].x+buttons[i].wh_size &&
                   my > buttons[i].y && my < buttons[i].y+buttons[i].wh_size) { buttons[i].click(); }
                }
            }
        clicked = false;
        updateEffects();
        var winner = true;
        for(var x = 0; x < field.size; x++)
        for(var y = 0; y < field.size; y++)
            {
            var curritem = field.getItem(x,y);
            if(curritem === undefined) { winner = false; continue; }
            if(!curritem.isalive) { curritem.destroy(); field.setItem(x,y, undefined); }
            else { curritem.act(); }
            }
        if(winner) { winflag = true; }
        if(winflag) { return; }
        shipt.act();
        if (!shipt.isalive) { shipt = new ship(1+Math.floor(Math.random()*3),Math.floor(Math.random()*field.size)); }
        
        }
    function GameLoop()
        {
        GameUpdate();
        ReDraw();
        setTimeout("requestAnimationFrame(GameLoop);",20);
        }
    function GameClick(e)
        {
        //console.log("Click ("+e.pageX+", "+e.pageY+")");
        mx = e.pageX-context.offsetLeft;
        my = e.pageY-context.offsetTop;
        clicked = true;
        //ReDraw();
        }
    context.onclick=GameClick;
    (function() {
      var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
                                  window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
      window.requestAnimationFrame = requestAnimationFrame;
    })();
    requestAnimationFrame(GameLoop);
</script><br/>
<table cellpadding="0" cellspacing="0" border="0" style="line-height:10px;">
<tr><td colspan="2" style="padding:0;"><a href="http://www.24log.de" target="_blank"><img border="0" src="http://counter.24log.ru/buttons/cl4/45-0.gif" alt="html counter" title="" style="margin:0;padding:0;" /></a><a href="http://www.24log.ru" target="_blank"><img border="0" src="http://counter.24log.ru/count4_252334_45_1_6.pcx" alt="счетчик посетителей сайта" title="счетчик для сайта" style="margin:0;padding:0;" /></a></td></tr></table>
</body>
</html>
